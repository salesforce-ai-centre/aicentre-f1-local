<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDP Packet Playback</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .player-card.rig-a {
            border-color: rgba(231, 76, 60, 0.5);
        }

        .player-card.rig-b {
            border-color: rgba(52, 152, 219, 0.5);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .rig-a .player-title {
            color: #e74c3c;
        }

        .rig-b .player-title {
            color: #3498db;
        }

        .remove-btn {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: rgba(255, 71, 87, 0.5);
        }

        .upload-zone {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-zone.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.2);
        }

        .upload-zone.loaded {
            border-color: rgba(46, 213, 115, 0.5);
            background: rgba(46, 213, 115, 0.1);
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-success {
            background: rgba(46, 213, 115, 0.3);
            color: #2ed573;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.1s linear;
        }

        .rig-a .progress-fill {
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
        }

        .rig-b .progress-fill {
            background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
        }

        .info-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
        }

        .settings-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 10px 0;
        }

        .settings-row label {
            min-width: 80px;
            font-size: 14px;
        }

        select, input[type="number"] {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .global-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .status.success {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        .status.error {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .status.info {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .add-player-card {
            border: 3px dashed rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-player-card:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìº UDP Packet Playback - Multi-Rig</h1>

        <div class="card" style="background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3);">
            <h3 style="color: #ffa500; margin-bottom: 10px;">‚ö†Ô∏è Visualization Only</h3>
            <p style="margin-bottom: 10px;">This web UI currently only visualizes packet files. It does <strong>not</strong> send actual UDP packets to the dashboard.</p>
            <p><strong>To actually play back recordings to the dashboard, use the command-line script:</strong></p>
            <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-top: 10px; overflow-x: auto;">
# Play back both rigs simultaneously:
./scripts/playback_all_rigs.sh recordings/lan_session

# Or manually:
python3 scripts/playback_udp_packets.py recordings/file.packets --port 20777</pre>
        </div>

        <div class="card">
            <div class="header-controls">
                <h2>üéÆ Playback Players (Visualization)</h2>
                <button class="btn btn-primary" id="addPlayerBtn">‚ûï Add Player</button>
            </div>
        </div>

        <div class="player-grid" id="playerGrid">
            <!-- Players will be added here dynamically -->
        </div>

        <div class="card" id="emptyState">
            <div class="empty-state">
                <div style="font-size: 64px; margin-bottom: 20px;">üì¶</div>
                <h2>No recordings loaded</h2>
                <p style="margin-top: 10px;">Click "Add Player" to start loading packet files</p>
            </div>
        </div>

        <!-- Global Controls -->
        <div class="card" id="globalControls" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 15px;">üéõÔ∏è Global Controls</h2>
            <div class="global-controls">
                <button class="btn btn-success" id="playAllBtn">‚ñ∂Ô∏è Play All</button>
                <button class="btn btn-secondary" id="pauseAllBtn">‚è∏Ô∏è Pause All</button>
                <button class="btn btn-secondary" id="stopAllBtn">‚èπÔ∏è Stop All</button>
            </div>
            <div id="globalStatus"></div>
        </div>
    </div>

    <script>
        let players = [];
        let nextPlayerId = 0;

        class PacketPlayer {
            constructor(id, rigType) {
                this.id = id;
                this.rigType = rigType; // 'rig-a' or 'rig-b'
                this.packets = [];
                this.metadata = {};
                this.isPlaying = false;
                this.currentPacketIndex = 0;
                this.startTime = 0;
                this.element = null;
            }

            render() {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-card ${this.rigType}`;
                playerDiv.id = `player-${this.id}`;

                playerDiv.innerHTML = `
                    <div class="player-header">
                        <div class="player-title">${this.rigType === 'rig-a' ? 'üî¥ RIG A' : 'üîµ RIG B'}</div>
                        <button class="remove-btn" onclick="removePlayer(${this.id})">‚ùå Remove</button>
                    </div>

                    <div class="upload-zone" id="upload-${this.id}">
                        <div style="font-size: 36px; margin-bottom: 10px;">üì¶</div>
                        <p>Drop packet file or click to browse</p>
                        <input type="file" id="fileInput-${this.id}" class="file-input" accept=".packets">
                    </div>

                    <div id="fileInfo-${this.id}" style="display: none;">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Total Packets</div>
                                <div class="info-value" id="totalPackets-${this.id}">0</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Duration</div>
                                <div class="info-value" id="duration-${this.id}">0s</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Port</div>
                                <div class="info-value" id="recordingPort-${this.id}">--</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Packets Sent</div>
                                <div class="info-value" id="packetsSent-${this.id}">0</div>
                            </div>
                        </div>

                        <div class="settings-row">
                            <label>Target Port:</label>
                            <input type="number" id="targetPort-${this.id}" value="${this.rigType === 'rig-a' ? '20777' : '20778'}" min="1" max="65535">
                        </div>

                        <div class="settings-row">
                            <label>Speed:</label>
                            <select id="speed-${this.id}">
                                <option value="0.25">0.25x</option>
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1.0x</option>
                                <option value="2">2.0x</option>
                                <option value="5">5.0x</option>
                            </select>
                            <label style="margin-left: 20px;">
                                <input type="checkbox" id="loop-${this.id}"> Loop
                            </label>
                        </div>

                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-${this.id}"></div>
                        </div>

                        <div style="text-align: center;">
                            <button class="btn btn-primary" id="playBtn-${this.id}">‚ñ∂Ô∏è Play</button>
                            <button class="btn btn-secondary" id="pauseBtn-${this.id}" disabled>‚è∏Ô∏è Pause</button>
                            <button class="btn btn-secondary" id="stopBtn-${this.id}" disabled>‚èπÔ∏è Stop</button>
                        </div>

                        <div id="status-${this.id}"></div>
                    </div>
                `;

                this.element = playerDiv;
                return playerDiv;
            }

            attachEvents() {
                const uploadZone = document.getElementById(`upload-${this.id}`);
                const fileInput = document.getElementById(`fileInput-${this.id}`);

                uploadZone.addEventListener('click', () => fileInput.click());
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) this.handleFile(file);
                });
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) this.handleFile(file);
                });

                document.getElementById(`playBtn-${this.id}`).addEventListener('click', () => this.play());
                document.getElementById(`pauseBtn-${this.id}`).addEventListener('click', () => this.pause());
                document.getElementById(`stopBtn-${this.id}`).addEventListener('click', () => this.stop());
            }

            async handleFile(file) {
                this.showStatus('Loading...', 'info');

                try {
                    const buffer = await file.arrayBuffer();
                    const view = new DataView(buffer);

                    // Read metadata
                    let offset = 0;
                    const metadataSize = view.getUint32(offset, true);
                    offset += 4;

                    const metadataBytes = new Uint8Array(buffer, offset, metadataSize);
                    const metadataJson = new TextDecoder().decode(metadataBytes);
                    this.metadata = JSON.parse(metadataJson);
                    offset += metadataSize;

                    // Skip separator
                    while (offset < buffer.byteLength && view.getUint8(offset) !== 0x2D) offset++;
                    while (offset < buffer.byteLength && view.getUint8(offset) !== 0x0A) offset++;
                    offset++;

                    // Read packets
                    this.packets = [];
                    while (offset < buffer.byteLength - 12) {
                        const timestamp = view.getFloat64(offset, true);
                        offset += 8;
                        const size = view.getUint32(offset, true);
                        offset += 4;
                        const data = new Uint8Array(buffer, offset, size);
                        offset += size;

                        this.packets.push({ timestamp, data });
                    }

                    // Update UI
                    document.getElementById(`upload-${this.id}`).classList.add('loaded');
                    document.getElementById(`fileInfo-${this.id}`).style.display = 'block';
                    document.getElementById(`totalPackets-${this.id}`).textContent = this.packets.length;
                    document.getElementById(`duration-${this.id}`).textContent = `${Math.round(this.metadata.duration || 0)}s`;
                    document.getElementById(`recordingPort-${this.id}`).textContent = this.metadata.port || '--';

                    this.showStatus(`‚úÖ Loaded ${this.packets.length} packets`, 'success');
                    updateGlobalControls();
                } catch (error) {
                    this.showStatus(`‚ùå Error: ${error.message}`, 'error');
                }
            }

            play() {
                if (this.packets.length === 0) return;

                this.isPlaying = true;
                document.getElementById(`playBtn-${this.id}`).disabled = true;
                document.getElementById(`pauseBtn-${this.id}`).disabled = false;
                document.getElementById(`stopBtn-${this.id}`).disabled = false;

                const speed = parseFloat(document.getElementById(`speed-${this.id}`).value);
                const targetPort = parseInt(document.getElementById(`targetPort-${this.id}`).value);
                const loop = document.getElementById(`loop-${this.id}`).checked;

                this.showStatus(`‚ñ∂Ô∏è Playing to localhost:${targetPort} (${speed}x)`, 'info');
                this.simulatePlayback(speed, loop);
            }

            simulatePlayback(speed, loop) {
                const baseTimestamp = this.packets[0].timestamp;
                this.startTime = Date.now();

                const sendNextPacket = () => {
                    if (!this.isPlaying || this.currentPacketIndex >= this.packets.length) {
                        if (loop && this.isPlaying && this.currentPacketIndex >= this.packets.length) {
                            this.currentPacketIndex = 0;
                            this.startTime = Date.now();
                        } else {
                            this.stop();
                            return;
                        }
                    }

                    const packet = this.packets[this.currentPacketIndex];
                    const relativeTime = (packet.timestamp - baseTimestamp) / speed;
                    const targetTime = this.startTime + (relativeTime * 1000);
                    const now = Date.now();
                    const delay = Math.max(0, targetTime - now);

                    setTimeout(() => {
                        if (!this.isPlaying) return;

                        this.currentPacketIndex++;
                        document.getElementById(`packetsSent-${this.id}`).textContent = this.currentPacketIndex;
                        const progress = (this.currentPacketIndex / this.packets.length) * 100;
                        document.getElementById(`progress-${this.id}`).style.width = `${progress}%`;

                        sendNextPacket();
                    }, delay);
                };

                sendNextPacket();
            }

            pause() {
                this.isPlaying = false;
                document.getElementById(`playBtn-${this.id}`).disabled = false;
                document.getElementById(`pauseBtn-${this.id}`).disabled = true;
                this.showStatus('‚è∏Ô∏è Paused', 'info');
            }

            stop() {
                this.isPlaying = false;
                this.currentPacketIndex = 0;
                document.getElementById(`playBtn-${this.id}`).disabled = false;
                document.getElementById(`pauseBtn-${this.id}`).disabled = true;
                document.getElementById(`stopBtn-${this.id}`).disabled = true;
                document.getElementById(`progress-${this.id}`).style.width = '0%';
                document.getElementById(`packetsSent-${this.id}`).textContent = '0';
                this.showStatus('‚èπÔ∏è Stopped', 'info');
            }

            showStatus(message, type) {
                const statusEl = document.getElementById(`status-${this.id}`);
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }
        }

        function addPlayer(rigType = null) {
            // Auto-select rig type if not specified
            if (!rigType) {
                const hasRigA = players.some(p => p.rigType === 'rig-a');
                const hasRigB = players.some(p => p.rigType === 'rig-b');
                rigType = !hasRigA ? 'rig-a' : !hasRigB ? 'rig-b' : 'rig-a';
            }

            const player = new PacketPlayer(nextPlayerId++, rigType);
            players.push(player);

            const grid = document.getElementById('playerGrid');
            grid.appendChild(player.render());
            player.attachEvents();

            document.getElementById('emptyState').style.display = 'none';
            updateGlobalControls();
        }

        function removePlayer(id) {
            players = players.filter(p => p.id !== id);
            document.getElementById(`player-${id}`).remove();

            if (players.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('globalControls').style.display = 'none';
            }
        }

        function updateGlobalControls() {
            const hasLoadedPlayers = players.some(p => p.packets.length > 0);
            document.getElementById('globalControls').style.display = hasLoadedPlayers ? 'block' : 'none';
        }

        document.getElementById('addPlayerBtn').addEventListener('click', () => addPlayer());

        document.getElementById('playAllBtn').addEventListener('click', () => {
            players.forEach(p => {
                if (p.packets.length > 0 && !p.isPlaying) p.play();
            });
        });

        document.getElementById('pauseAllBtn').addEventListener('click', () => {
            players.forEach(p => {
                if (p.isPlaying) p.pause();
            });
        });

        document.getElementById('stopAllBtn').addEventListener('click', () => {
            players.forEach(p => {
                if (p.isPlaying || p.currentPacketIndex > 0) p.stop();
            });
        });

        // Initialize with 2 players (RIG A and RIG B)
        addPlayer('rig-a');
        addPlayer('rig-b');
    </script>
</body>
</html>
