╔═══════════════════════════════════════════════════════════════════════════════╗
║                    F1 RACE FLOW SYSTEM - COMPLETE ARCHITECTURE                ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                              USER JOURNEY FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │   ATTRACT   │  ← Start here (overhead display)
    │   SCREEN    │
    │             │
    │ ┌─────────┐ │
    │ │ QR RIG1 │ │  Shows QR codes for both rigs
    │ └─────────┘ │  + Leaderboards (daily/monthly/track)
    │ ┌─────────┐ │  + Current F1 race info
    │ │ QR RIG2 │ │
    │ └─────────┘ │
    └──────┬──────┘
           │
           │ User scans QR code
           ↓
    ┌─────────────┐
    │  QR LANDING │
    │    PAGE     │
    │             │
    │ • Nickname  │  Form submission creates session
    │ • Terms ☑   │  Status: "Waiting"
    │ • Safety ☑  │
    └──────┬──────┘
           │
           │ Submit form → POST /api/session
           ↓
    ┌─────────────┐
    │  DASHBOARD  │
    │  (WAITING)  │
    │             │
    │ "Ready to   │  Session in "Waiting" state
    │  start..."  │  Waiting for telemetry
    └──────┬──────┘
           │
           │ User starts F1 game
           │ Telemetry begins flowing
           ↓
    ┌─────────────┐
    │  DASHBOARD  │
    │  (ACTIVE)   │
    │             │  Session transitions to "Active"
    │ • Live data │  Real-time telemetry updates
    │ • Lap times │  Tracks best laps/sectors/speed
    │ • Speed     │
    │ • Position  │
    └──────┬──────┘
           │
           │ Race completes
           │ UDP "SEND" event detected
           ↓
    ┌─────────────┐
    │   SUMMARY   │
    │   SCREEN    │
    │             │  Session completed automatically
    │ 🏆 Stats    │  Shows final statistics
    │ • Best Lap  │  10-second countdown
    │ • Sectors   │
    │ • Top Speed │
    └──────┬──────┘
           │
           │ 10 seconds elapsed
           │
           ↓
    ┌─────────────┐
    │   ATTRACT   │  ← Loop back (leaderboards updated)
    │   SCREEN    │
    └─────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                           BACKEND ARCHITECTURE                               │
└─────────────────────────────────────────────────────────────────────────────┘

    ╔═══════════════╗
    ║  FLASK APP    ║  Port 8080
    ║   (app.py)    ║
    ╚═══════════════╝
            │
            ├──────────────────┬──────────────────┬──────────────────┐
            ↓                  ↓                  ↓                  ↓
    ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
    │   SERVICES    │  │   API ROUTES  │  │  SSE STREAM   │  │   TEMPLATES   │
    │               │  │               │  │               │  │               │
    │ • Session Svc │  │ POST /api/    │  │ GET /stream   │  │ attract.html  │
    │ • Calendar    │  │      session  │  │               │  │ start.html    │
    │   Service     │  │ GET  /api/    │  │ Broadcasts    │  │ summary.html  │
    │               │  │      leaderbd │  │ telemetry     │  │ index.html    │
    └───────┬───────┘  └───────────────┘  └───────────────┘  └───────────────┘
            │
            ↓
    ┌───────────────┐
    │ REPOSITORIES  │
    │               │
    │ • Session     │  SOQL-like query patterns
    │   Repository  │  Leaderboard logic
    │ • Database    │
    └───────┬───────┘
            │
            ↓
    ┌───────────────┐
    │    MODELS     │
    │               │
    │ • Session__c  │  Salesforce naming conventions
    │ • LapRecord__c│  __c suffix for custom fields
    └───────┬───────┘
            │
            ↓
    ┌───────────────┐
    │    SQLite     │  data/f1_telemetry.db
    │   DATABASE    │
    │               │  Designed for Salesforce migration
    │ • Session__c  │
    │ • Lap_Record__c
    └───────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                         UDP TELEMETRY INTEGRATION                            │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │  F1 GAME    │  UDP Port 20777
    │  (PC/PS5)   │
    └──────┬──────┘
           │ Binary UDP packets
           ↓
    ┌─────────────┐
    │  RECEIVER   │  src/receiver.py
    │  (UDP)      │
    │             │  Decodes binary protocol
    │ • Decodes   │  Detects events (SEND, FTLP, etc.)
    │ • Parses    │  Aggregates data
    │ • Events    │
    └──────┬──────┘
           │
           │ HTTP POST /data?sessionId=xxx
           │ JSON payload
           ↓
    ┌─────────────┐
    │  FLASK APP  │  Receives telemetry
    │  /data      │
    │             │  Updates session in real-time
    │ • Detect    │  Detects SEND event → complete session
    │   events    │  Broadcasts to SSE clients
    │ • Update    │
    │   session   │
    └──────┬──────┘
           │
           ├──────────────────┬──────────────────┐
           ↓                  ↓                  ↓
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │  DATABASE   │  │ SSE STREAM  │  │ DATA CLOUD  │
    │             │  │             │  │ (Optional)  │
    │ Update best │  │ Broadcast   │  │             │
    │ laps/times  │  │ to browser  │  │ Send events │
    └─────────────┘  └─────────────┘  └─────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                          SESSION STATE MACHINE                               │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │   WAITING   │  Created from QR landing form
    │             │  Driver name, terms accepted
    │ Status: New │  Race context from calendar
    └──────┬──────┘
           │
           │ POST /api/session/{id}/start
           │ OR: First telemetry received
           ↓
    ┌─────────────┐
    │   ACTIVE    │  Telemetry flowing
    │             │  Tracking best laps, sectors
    │ Racing...   │  Updating session continuously
    └──────┬──────┘
           │
           │ UDP "SEND" event received
           │ OR: POST /api/session/{id}/complete
           ↓
    ┌─────────────┐
    │  COMPLETED  │  Final stats calculated
    │             │  Available in leaderboards
    │ Session End │  Summary screen displayed
    └─────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                           DATABASE SCHEMA                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌────────────────────────────────────────────┐
    │           Session__c                       │
    │  (Salesforce Custom Object Pattern)        │
    ├────────────────────────────────────────────┤
    │ Id (PK)                        TEXT        │
    │ Name                           TEXT        │  SES-20251023-RIG1-0001
    │ CreatedDate                    TEXT        │
    │ LastModifiedDate               TEXT        │
    ├────────────────────────────────────────────┤
    │ Rig_Number__c                  INTEGER     │  1 or 2
    │ Driver_Name__c                 TEXT        │
    │ Track_Name__c                  TEXT        │
    │ Circuit_Name__c                TEXT        │
    │ Session_Status__c              TEXT        │  Waiting/Active/Completed
    ├────────────────────────────────────────────┤
    │ Race_Round__c                  INTEGER     │
    │ Race_Name__c                   TEXT        │
    │ Race_Country__c                TEXT        │
    │ Race_Date__c                   TEXT        │
    ├────────────────────────────────────────────┤
    │ Session_Start_Time__c          TEXT        │
    │ Session_End_Time__c            TEXT        │
    │ Session_Duration_Seconds__c    REAL        │
    ├────────────────────────────────────────────┤
    │ Best_Lap_Time__c               REAL        │  Milliseconds
    │ Best_Lap_Number__c             INTEGER     │
    │ Best_Sector_1_Time__c          REAL        │
    │ Best_Sector_2_Time__c          REAL        │
    │ Best_Sector_3_Time__c          REAL        │
    │ Average_Lap_Time__c            REAL        │
    │ Top_Speed__c                   REAL        │  km/h
    │ Total_Laps__c                  INTEGER     │
    ├────────────────────────────────────────────┤
    │ Terms_Accepted__c              INTEGER     │  Boolean
    │ Safety_Rules_Accepted__c       INTEGER     │  Boolean
    └────────────────────────────────────────────┘

    ┌────────────────────────────────────────────┐
    │           Lap_Record__c                    │
    │  (Child Object - Future Implementation)    │
    ├────────────────────────────────────────────┤
    │ Id (PK)                        TEXT        │
    │ Session__c (FK)                TEXT        │  → Session__c.Id
    │ Lap_Number__c                  INTEGER     │
    │ Lap_Time__c                    REAL        │
    │ Sector_1/2/3_Time__c          REAL        │
    │ Is_Best_Lap__c                 INTEGER     │
    │ Max_Speed__c                   REAL        │
    └────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                          API ENDPOINT MAP                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    SESSION MANAGEMENT:
    ┌────────────────────────────────────────────────────────────┐
    │ POST   /api/session                                        │
    │        Create new session (from QR landing form)           │
    │        Body: {rigNumber, driverName, terms, safety}        │
    ├────────────────────────────────────────────────────────────┤
    │ POST   /api/session/{id}/start                            │
    │        Start session (Waiting → Active)                    │
    ├────────────────────────────────────────────────────────────┤
    │ POST   /api/session/{id}/complete                         │
    │        Complete session (Active → Completed)               │
    │        Returns: Session summary                            │
    ├────────────────────────────────────────────────────────────┤
    │ GET    /api/session/{id}                                  │
    │        Get session details                                 │
    ├────────────────────────────────────────────────────────────┤
    │ GET    /api/session/active/{rigNumber}                    │
    │        Check if rig has active session                     │
    └────────────────────────────────────────────────────────────┘

    LEADERBOARDS:
    ┌────────────────────────────────────────────────────────────┐
    │ GET    /api/leaderboard/daily                             │
    │        Today's best laps (all tracks)                      │
    │        Query: ?track=Monaco&limit=10                       │
    ├────────────────────────────────────────────────────────────┤
    │ GET    /api/leaderboard/monthly                           │
    │        This month's best laps                              │
    ├────────────────────────────────────────────────────────────┤
    │ GET    /api/leaderboard/track                             │
    │        All-time track records                              │
    │        Query: ?track=Monaco (required)                     │
    └────────────────────────────────────────────────────────────┘

    CALENDAR:
    ┌────────────────────────────────────────────────────────────┐
    │ GET    /api/calendar/current                              │
    │        Current F1 race + next 3 races                      │
    │        Auto-selects from F1-25/26-Calendar.json            │
    └────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                      F1 CALENDAR INTEGRATION                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────┐       ┌───────────────────┐
    │ F1-25-Calendar    │       │ F1-26-Calendar    │
    │    .json          │       │    .json          │
    └─────────┬─────────┘       └─────────┬─────────┘
              │                           │
              └───────────┬───────────────┘
                          │
                          ↓
                ┌─────────────────┐
                │ CalendarService │
                │                 │
                │ Auto-detects    │  Based on current date:
                │ current race    │  • Loads correct calendar year
                │                 │  • Finds next upcoming race
                └────────┬────────┘  • Falls back to last race
                         │
                         ↓
        ┌────────────────────────────────────┐
        │  Race Context Applied to Session:  │
        ├────────────────────────────────────┤
        │  • Race_Name__c                    │  "Monaco Grand Prix"
        │  • Track_Name__c                   │  "Monaco"
        │  • Circuit_Name__c                 │  "Circuit de Monaco"
        │  • Race_Round__c                   │  8
        │  • Race_Country__c                 │  "Monaco"
        │  • Race_Date__c                    │  "2026-06-05"
        └────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                        DEPLOYMENT TOPOLOGY                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────┐
    │                    Server Machine                            │
    │  (MacBook, PC, or dedicated server)                         │
    │                                                              │
    │  ┌──────────────────────────────────────────────────────┐  │
    │  │  Flask App (Port 8080)                               │  │
    │  │  • Web server                                        │  │
    │  │  • API endpoints                                     │  │
    │  │  • SSE broadcasting                                  │  │
    │  └──────────────────────────────────────────────────────┘  │
    │                                                              │
    │  ┌──────────────────────────────────────────────────────┐  │
    │  │  UDP Receiver (Port 20777)                           │  │
    │  │  • Listens for F1 game telemetry                     │  │
    │  │  • Sends to Flask /data endpoint                     │  │
    │  └──────────────────────────────────────────────────────┘  │
    │                                                              │
    │  ┌──────────────────────────────────────────────────────┐  │
    │  │  SQLite Database                                     │  │
    │  │  data/f1_telemetry.db                                │  │
    │  └──────────────────────────────────────────────────────┘  │
    └────┬─────────────────────────────────────────────────┬─────┘
         │                                                 │
         │ HTTP 8080                                       │ UDP 20777
         │                                                 │
    ┌────┴────────┐     ┌──────────────┐     ┌───────────┴──────┐
    │  Overhead   │     │ User Mobile  │     │   F1 Game (Rig1) │
    │  Display    │     │   Devices    │     │   PC/PS5         │
    │             │     │              │     └──────────────────┘
    │ /attract    │     │ Scan QR      │
    │ screen      │     │ → /start     │     ┌──────────────────┐
    └─────────────┘     └──────────────┘     │   F1 Game (Rig2) │
                                             │   PC/PS5         │
    ┌─────────────┐                          └──────────────────┘
    │  Rig 1      │
    │  Monitor    │
    │             │
    │ Dashboard   │
    │ /           │
    └─────────────┘

    ┌─────────────┐
    │  Rig 2      │
    │  Monitor    │
    │             │
    │ Dashboard   │
    │ /           │
    └─────────────┘


═══════════════════════════════════════════════════════════════════════════════
                              KEY FEATURES
═══════════════════════════════════════════════════════════════════════════════

✅ Salesforce-ready architecture (easy migration path)
✅ Complete user journey (attract → race → summary → loop)
✅ QR code registration (frictionless onboarding)
✅ Real-time telemetry tracking
✅ Auto-detects F1 race from calendar
✅ Three types of leaderboards (daily/monthly/track)
✅ Event-driven session completion (UDP SEND event)
✅ Auto-redirects between screens
✅ Session persistence with SQLite
✅ Comprehensive API (Salesforce REST pattern)
✅ Responsive UI design

═══════════════════════════════════════════════════════════════════════════════
